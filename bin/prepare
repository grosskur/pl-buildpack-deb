#!/bin/bash

# fail fast
set -o errexit
set -o nounset
set -o pipefail

scriptname=$(basename $0)
case $# in
  1) :;;
  *) echo "$scriptname: usage: $scriptname BUILD_DIR" >&2; exit 2;;
esac

build_dir="$1"
vendor_apt_url=http://s3.amazonaws.com/cb-misc/lucid-amd64/vendor-apt-1.0.5.tar.gz
python=$build_dir/.heroku/python/bin/python

mkdir -p "$build_dir"/.heroku
curl -fsSL $vendor_apt_url | tar -C "$build_dir"/.heroku -xzf -

cat <<EOT
---
packages:
  - build-essential
  - ccache
  - debhelper
  - devscripts
  - fakeroot
  - python-support
EOT

cat <<EOT >/tmp/get_deps.py
from cStringIO import StringIO
import sys

from apt.cache import Cache
from apt.debfile import DscSrcPackage

deb = DscSrcPackage(sys.argv[1], Cache())
deb.check()
for p in deb.required_changes[0]:
    print p
EOT

echo 'APT::Install-Recommends "false";' >/tmp/apt.conf

dsc=
if ls $build_dir/*.dsc >/dev/null 2>&1
then
  dsc=$build_dir/*.dsc
elif test -e $build_dir/debian/control
then
  dsc=$build_dir/debian/control
fi

export APT_CONFIG=/tmp/apt.conf
export LD_LIBRARY_PATH=$build_dir/.heroku/python/lib:$build_dir/.heroku/vendor/lib

"$build_dir"/.heroku/python/bin/python /tmp/get_deps.py "$dsc" \
| sort -u \
| uniq \
| sed 's/^/  - /'

rm -rf "$build_dir"/.heroku
